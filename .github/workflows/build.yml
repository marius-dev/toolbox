name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

jobs:
  # Quality checks for main branch changes
  checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .
      
      - name: Analyze code
        run: flutter analyze
      
      - name: Run tests
        run: flutter test --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Linux builds for x64 and ARM64
  # Single build works across distros (Ubuntu, Fedora, Debian, Arch, etc.)
  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: checks
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
      
      - name: Install ARM64 dependencies
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
      
      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Linux app (x64)
        if: matrix.arch == 'x64'
        run: flutter build linux --release
      
      - name: Build Linux app (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          flutter build linux --release --target-platform linux-arm64
      
      - name: Package Linux build
        run: |
          cd build/linux/${{ matrix.arch }}/release/bundle
          tar -czf ${{ github.workspace }}/flutter-linux-${{ matrix.arch }}.tar.gz *
      
      - name: Create AppImage (x64 only - most portable)
        if: matrix.arch == 'x64'
        run: |
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          # Create desktop file
          cat > AppDir/flutter_app.desktop << EOF
          [Desktop Entry]
          Name=Flutter App
          Exec=flutter_app
          Icon=flutter_app
          Type=Application
          Categories=Utility;
          EOF
          
          # Create simple icon (replace with your actual icon)
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          # Copy your icon: cp assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/flutter_app.png
          
          # Build AppImage
          ARCH=x86_64 ./appimagetool AppDir flutter-linux-x64.AppImage || echo "AppImage creation skipped - add icon"
      
      - name: Upload Linux tarball
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}-build
          path: flutter-linux-${{ matrix.arch }}.tar.gz
      
      - name: Upload AppImage
        if: matrix.arch == 'x64'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: linux-appimage
          path: flutter-linux-x64.AppImage

  # macOS builds for Intel (x64) and Apple Silicon (ARM64)
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: checks
    strategy:
      matrix:
        include:
          - arch: x64
            flutter_arch: x86_64
          - arch: arm64
            flutter_arch: arm64
          - arch: universal
            flutter_arch: universal
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build macOS app
        run: |
          if [ "${{ matrix.arch }}" == "universal" ]; then
            flutter build macos --release
          else
            flutter build macos --release --target-platform darwin-${{ matrix.flutter_arch }}
          fi
      
      - name: Package macOS build
        run: |
          cd build/macos/Build/Products/Release
          ditto -c -k --sequesterRsrc --keepParent *.app ${{ github.workspace }}/flutter-macos-${{ matrix.arch }}.zip
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-build
          path: flutter-macos-${{ matrix.arch }}.zip

  # Windows builds for x64 and ARM64
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: checks
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Windows app (x64)
        if: matrix.arch == 'x64'
        run: flutter build windows --release
      
      - name: Build Windows app (ARM64)
        if: matrix.arch == 'arm64'
        run: flutter build windows --release --target-platform windows-arm64
      
      - name: Package Windows build
        run: |
          Compress-Archive -Path build/windows/${{ matrix.arch }}/runner/Release/* -DestinationPath flutter-windows-${{ matrix.arch }}.zip
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}-build
          path: flutter-windows-${{ matrix.arch }}.zip

  # Create GitHub release with all builds
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos, build-windows]
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/linux-x64-build/flutter-linux-x64.tar.gz
            artifacts/linux-arm64-build/flutter-linux-arm64.tar.gz
            artifacts/linux-appimage/flutter-linux-x64.AppImage
            artifacts/macos-x64-build/flutter-macos-x64.zip
            artifacts/macos-arm64-build/flutter-macos-arm64.zip
            artifacts/macos-universal-build/flutter-macos-universal.zip
            artifacts/windows-x64-build/flutter-windows-x64.zip
            artifacts/windows-arm64-build/flutter-windows-arm64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Downloads
            
            ### Linux (Works on ALL distros: Ubuntu, Fedora, Debian, Arch, etc.)
            - **x64 Tarball**: `flutter-linux-x64.tar.gz` (Extract and run - works everywhere)
            - **x64 AppImage**: `flutter-linux-x64.AppImage` (Single file, double-click to run - most portable)
            - **ARM64**: `flutter-linux-arm64.tar.gz` (Raspberry Pi 4+, ARM servers)
            
            **Linux Installation:**
            - Tarball: Extract and run the executable
            - AppImage: `chmod +x flutter-linux-x64.AppImage && ./flutter-linux-x64.AppImage`
            
            ### macOS
            - **x64**: `flutter-macos-x64.zip` (Intel Macs)
            - **ARM64**: `flutter-macos-arm64.zip` (Apple Silicon M1/M2/M3)
            - **Universal**: `flutter-macos-universal.zip` (Works on both Intel and Apple Silicon) â­ Recommended
            
            ### Windows
            - **x64**: `flutter-windows-x64.zip` (Intel/AMD 64-bit)
            - **ARM64**: `flutter-windows-arm64.zip` (ARM 64-bit, e.g., Surface Pro X)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}